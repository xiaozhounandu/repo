<html>
<meta charset="UTF-8">
<head></head>
<bidy>

</bidy>

<script>
    // function extractJsonAndTextFromAnswer(answer) {
    //     let json = {};
    //     let text = answer;
    //     if (!answer) return { json: {}, text: '' };
    //     const start = answer.indexOf('{');
    //     const end = answer.lastIndexOf('}');

    //     if (start !== -1 && end !== -1 && end > start) {
    //         try {
    //             const jsonStr = answer.substring(start, end + 1);
    //             json = JSON.parse(jsonStr);
    //             const preText = answer.substring(0, start).trim();
    //             const postText = answer.substring(end + 1).trim();
    //             text = (preText + "\n" + postText).trim();
    //         } catch (e) {
    //             json = {};
    //             text = answer;
    //         }
    //     }
    //     return { json: json, text: text };
    // }

    // // =========================================================
    // // II. 核心事件绑定 (最终版本)
    // // =========================================================
    // WfForm.bindFieldChangeEvent("field22492", function(obj, id, value){

    //     // **注意：上线时请务必将 44548 替换为 let fileIds = value;**
    //     let fileIds = 44649;

    //     console.log("DEBUG_TRIGGER: field22492 事件已触发。附件ID Value:", fileIds);

    //     if (!fileIds) {
    //         let resultEl = document.getElementById("result");
    //         if (resultEl) resultEl.textContent = "附件ID为空，无数据需要解析。";
    //         return;
    //     }

    //     function autoUpload() {

    //         let targetNode = obj.parentNode;
    //         let resultEl = document.getElementById("result");
    //         let rawEl = document.getElementById("rawResponse");

    //         // 简化的 DOM 查找/创建逻辑，确保 resultEl 和 rawEl 存在
    //         if (!resultEl) { resultEl = document.createElement("pre"); resultEl.id = "result"; targetNode.appendChild(resultEl); }
    //         if (!rawEl) { rawEl = document.createElement("pre"); rawEl.id = "rawResponse"; targetNode.appendChild(rawEl); }

    //         resultEl.textContent = "【AI 解析结果】处理中，请稍候…";

    //         const apiUrl = `http://42.193.124.96:8080/api/auto-upload?fieldId=${fileIds}`;
    //         console.log("DEBUG_API_CALL: 请求 URL:", apiUrl);

    //         jQuery.ajax({
    //             url: apiUrl,
    //             method: "GET",
    //             dataType: "json",
    //             timeout: 30000,
    //             success: function(data) {
    //                 console.log("DEBUG_API_SUCCESS: API 调用成功。", data);

    //                 const filesData = Array.isArray(data) ? data : [data];

    //                 if (filesData.length === 0) {
    //                     resultEl.textContent = "【AI 解析结果】API返回数据为空。";
    //                     return;
    //                 }

    //                 // --- 明细表配置 ---
    //                 const DETAIL_TABLE_ID = "detail_1"; // ***请确认您的明细表 ID***
    //                 const FIELD_MAPPING = {
    //                     "发票号码": "field23890",
    //                     "开票日期": "field23891",
    //                     "金额": "field23892",
    //                     "税额": "field23893",
    //                     "购买方名称": "field23894",
    //                     "销售方名称": "field23895"
    //                 };

    //                 // 1. 修正后的清空明细表方法：使用 WfForm.delDetailRow()
    //                 try {
    //                     WfForm.delDetailRow(DETAIL_TABLE_ID, "all");
    //                 } catch (e) {
    //                     console.error(`明细表清空失败，请检查 DETAIL_TABLE_ID 是否正确或尝试其他删除 API: ${e}`);
    //                 }

    //                 resultEl.textContent = `【AI 解析结果】已接收到 ${filesData.length} 条数据，开始写入明细表...`;
    //                 let allRawResponseText = "";
    //                 let outputSummary = "--- 写入明细表结果 ---\n";

    //                 filesData.forEach((fileData, index) => {
    //                     let rawResponseText = fileData.raw_response || JSON.stringify(fileData, null, 2);
    //                     allRawResponseText += `--- 文件 ${index + 1} 原始响应 ---\n${rawResponseText}\n\n`;

    //                     try {
    //                         let rawJson = JSON.parse(rawResponseText);
    //                         const answerContent = rawJson.answer || "";
    //                         const { json: invoiceData } = extractJsonAndTextFromAnswer(answerContent);

    //                         let rowData = {};
    //                         let rowWritten = false;

    //                         for (const jsonKey in FIELD_MAPPING) {
    //                             const fieldId = FIELD_MAPPING[jsonKey];
    //                             const valueToWrite = invoiceData[jsonKey] || '';

    //                             if (valueToWrite) {
    //                                 rowData[fieldId] = {value: valueToWrite};
    //                                 rowWritten = true;
    //                             }
    //                         }

    //                         // 2. 新增并赋值
    //                         if (rowWritten) {
    //                           WfForm.addDetailRow(DETAIL_TABLE_ID, rowData);
    //                         outputSummary += `文件 ${index + 1}: 写入成功。发票号码: ${invoiceData["发票号码"] || '无'} 开票日期: ${invoiceData["开票日期"] || '无'}\n`;
    //                         } else {
    //                           outputSummary += `文件 ${index + 1}: 无有效数据写入，已跳过。\n`;
    //                         }

    //                     } catch (e) {
    //                         console.error(`处理文件 ${index + 1} 失败:`, e);
    //                         outputSummary += `文件 ${index + 1} 处理失败: ${e.message}\n`;
    //                     }
    //                 });

    //                 // 3. 更新前端展示区域
    //                 resultEl.textContent = outputSummary;
    //                 rawEl.textContent = allRawResponseText;

    //             },
    //             error: function(jqXHR, textStatus, errorThrown) {
    //                 console.error("DEBUG_API_ERROR: API 调用失败。", {textStatus, errorThrown, jqXHR});
    //                 resultEl.textContent = `【致命错误】API 调用失败！请检查控制台和网络标签页。状态: ${textStatus}`;
    //             }
    //         });
    //     }

    //     autoUpload();
    // });

    // =========================================================
    // I. 辅助函数定义 (保持不变)
    // =========================================================
    function extractJsonAndTextFromAnswer(answer) {
        let json = {};
        let text = answer;
        if (!answer) return { json: {}, text: '' };
        const start = answer.indexOf('{');
        const end = answer.lastIndexOf('}');

        if (start !== -1 && end !== -1 && end > start) {
            try {
                const jsonStr = answer.substring(start, end + 1);
                json = JSON.parse(jsonStr);
                const preText = answer.substring(0, start).trim();
                const postText = answer.substring(end + 1).trim();
                text = (preText + "\n" + postText).trim();
            } catch (e) {
                json = {};
                text = answer;
            }
        }
        return { json: json, text: text };
    }

    // =========================================================
    // II. 核心事件绑定 (最终版本)
    // =========================================================
    // WfForm.bindFieldChangeEvent("field22492", function(obj, id, value){

    //     // **注意：上线时请务必将 44548 替换为 let fileIds = value;**
    //     let fileIds = 44677;
    //       alert(value);

    //     console.log("DEBUG_TRIGGER: field22492 事件已触发。附件ID Value:", fileIds);

    //     if (!fileIds) {
    //         let resultEl = document.getElementById("result");
    //         if (resultEl) resultEl.textContent = "附件ID为空，无数据需要解析。";
    //         return;
    //     }

    //     function autoUpload() {

    //         let targetNode = obj.parentNode;
    //         let resultEl = document.getElementById("result");
    //         let rawEl = document.getElementById("rawResponse");

    //         // 简化的 DOM 查找/创建逻辑，确保 resultEl 和 rawEl 存在
    //         if (!resultEl) { resultEl = document.createElement("pre"); resultEl.id = "result"; targetNode.appendChild(resultEl); }
    //         if (!rawEl) { rawEl = document.createElement("pre"); rawEl.id = "rawResponse"; targetNode.appendChild(rawEl); }

    //         resultEl.textContent = "【AI 解析结果】处理中，请稍候…";

    //         const apiUrl = `http://42.193.124.96:8080/api/auto-upload?fieldId=${fileIds}`;
    //         console.log("DEBUG_API_CALL: 请求 URL:", apiUrl);

    //         jQuery.ajax({
    //             url: apiUrl,
    //             method: "GET",
    //             dataType: "json",
    //             timeout: 30000,
    //             success: function(data) {
    //                 console.log("DEBUG_API_SUCCESS: API 调用成功。", data);

    //                 const filesData = Array.isArray(data) ? data : [data];

    //                 if (filesData.length === 0) {
    //                     resultEl.textContent = "【AI 解析结果】API返回数据为空。";
    //                     return;
    //                 }

    //                 // --- 明细表配置 ---
    //                 const DETAIL_TABLE_ID = "detail_1"; // ***请确认您的明细表 ID***
    //                 const FIELD_MAPPING = {
    //                     "发票号码": "field23890",
    //                     "开票日期": "field23891",
    //                     "金额": "field23892",
    //                     "税额": "field23893",
    //                     "购买方名称": "field23894",
    //                     "销售方名称": "field23895"
    //                 };

    //                 // 1. 修正后的清空明细表方法：使用 WfForm.delDetailRow()
    //                 try {
    //                     WfForm.delDetailRow(DETAIL_TABLE_ID, "all");
    //                 } catch (e) {
    //                     console.error(`明细表清空失败，请检查 DETAIL_TABLE_ID 是否正确或尝试其他删除 API: ${e}`);
    //                 }

    //                 resultEl.textContent = `【AI 解析结果】已接收到 ${filesData.length} 条数据，开始写入明细表...`;
    //                 let allRawResponseText = "";
    //                 let outputSummary = "--- 写入明细表结果 ---\n";

    //                 filesData.forEach((fileData, index) => {
    //                     let rawResponseText = fileData.raw_response || JSON.stringify(fileData, null, 2);
    //                     allRawResponseText += `--- 文件 ${index + 1} 原始响应 ---\n${rawResponseText}\n\n`;

    //                     try {
    //                         let rawJson = JSON.parse(rawResponseText);
    //                         const answerContent = rawJson.answer || "";
    //                         const { json: invoiceData } = extractJsonAndTextFromAnswer(answerContent);

    //                         let rowData = {};
    //                         let rowWritten = false;

    //                         for (const jsonKey in FIELD_MAPPING) {
    //                             const fieldId = FIELD_MAPPING[jsonKey];
    //                             const valueToWrite = invoiceData[jsonKey] || '';

    //                             if (valueToWrite) {
    //                                 rowData[fieldId] = {value: valueToWrite};
    //                                 rowWritten = true;
    //                             }
    //                         }

    //                         // 2. 新增并赋值
    //                         if (rowWritten) {
    //                           WfForm.addDetailRow(DETAIL_TABLE_ID, rowData);
    //                           outputSummary += `文件 ${index + 1}: 写入成功。发票号码: ${invoiceData["发票号码"] || '无'}\n`;
    //                         } else {
    //                           outputSummary += `文件 ${index + 1}: 无有效数据写入，已跳过。\n`;
    //                         }

    //                     } catch (e) {
    //                         console.error(`处理文件 ${index + 1} 失败:`, e);
    //                         outputSummary += `文件 ${index + 1} 处理失败: ${e.message}\n`;
    //                     }
    //                 });

    //                 // 3. 更新前端展示区域
    //                 resultEl.textContent = outputSummary;
    //                 rawEl.textContent = allRawResponseText;

    //             },
    //             error: function(jqXHR, textStatus, errorThrown) {
    //                 console.error("DEBUG_API_ERROR: API 调用失败。", {textStatus, errorThrown, jqXHR});
    //                 resultEl.textContent = `【致命错误】API 调用失败！请检查控制台和网络标签页。状态: ${textStatus}`;
    //             }
    //         });
    //     }

    //     autoUpload();
    // });

    // =========================================================
  // II. 核心事件绑定 (采用多请求拆分逻辑，解决 400 错误，并处理数字ID)
  // =========================================================
  WfForm.bindFieldChangeEvent("field15258", function(obj, id, value){

      // **注意：我们使用 value，它是 E9 附件字段的实际值**
      let fileIds = value;

      console.log("DEBUG_TRIGGER: field22492 事件已触发。附件ID Value:", fileIds);

      // 检查 fileIds 是否为空或无效（对数字和字符串都有效）
      if (!fileIds) {
          let resultEl = document.getElementById("result");
          if (resultEl) resultEl.textContent = "附件ID为空，无数据需要解析。";
          return;
      }

      function autoUpload() {

          let targetNode = obj.parentNode;
          let resultEl = document.getElementById("result");
          let rawEl = document.getElementById("rawResponse");

          // 确保 DOM 元素存在
          if (!resultEl) { resultEl = document.createElement("pre"); resultEl.id = "result"; targetNode.appendChild(resultEl); }
          if (!rawEl) { rawEl = document.createElement("pre"); rawEl.id = "rawResponse"; targetNode.appendChild(rawEl); }

          resultEl.textContent = "【AI 解析结果】处理中，请稍候…";

          // ? 修正点：使用 String() 强制将 fileIds 转换为字符串再进行 split
          const idArray = String(fileIds).split(',').filter(id => id.trim() !== '');

          if (idArray.length === 0) {
               resultEl.textContent = "附件ID为空，无数据需要解析。";
               return;
          }

          const DETAIL_TABLE_ID = "detail_1";
          const FIELD_MAPPING = {
              "项目名称": "field16902",
              "价税合计（小写）": "field16904",
              "税额": "field16906",
              "发票号码": "field16910"
          };

          // 清空明细表
          try {
              WfForm.delDetailRow(DETAIL_TABLE_ID, "all");
          } catch (e) {
              console.error(`明细表清空失败: ${e}`);
          }

          resultEl.textContent = `【AI 解析结果】准备发送 ${idArray.length} 个独立请求...`;

          let totalProcessedCount = 0;
          let outputSummary = "--- 写入明细表结果 ---\n";
          let allRawResponseText = "";

          // 3. 创建并发送多个独立的 AJAX 请求
          const ajaxRequests = jQuery.map(idArray, function(singleId, index) {
              // singleId 已经是字符串形式
              const apiUrl = `http://42.193.124.96:8080/api/auto-upload?fieldId=${singleId}`;
              console.log(`DEBUG_API_CALL_${index+1}: 请求 URL:`, apiUrl);

              return jQuery.ajax({
                  url: apiUrl,
                  method: "GET",
                  dataType: "json",
                  timeout: 30000
              }).then(function(data) {
                  // 请求成功：处理单个文件数据
                  const fileData = Array.isArray(data) ? data[0] : data;

                  let rawResponseText = fileData.raw_response || JSON.stringify(fileData, null, 2);
                  allRawResponseText += `--- 文件 ${index + 1} (ID: ${singleId}) 原始响应 ---\n${rawResponseText}\n\n`;

                  try {
                      // 由于 raw_response 本身是字符串，需要先解析
                      let rawJson = JSON.parse(rawResponseText);
                      const answerContent = rawJson.answer || "";
                      const { json: invoiceData } = extractJsonAndTextFromAnswer(answerContent);


                      let rowData = {};
                      let rowWritten = false;

                      // 构造要写入的数据对象
                      for (const jsonKey in FIELD_MAPPING) {
                          const fieldId = FIELD_MAPPING[jsonKey];
                          const valueToWrite = invoiceData[jsonKey] || '';

                          if (valueToWrite) {
                              rowData[fieldId] = {value: valueToWrite};
                              rowWritten = true;
                          }
                      }

                      // 新增明细行并赋值
                      if (rowWritten) {
                         WfForm.addDetailRow(DETAIL_TABLE_ID, rowData);
                         outputSummary += `文件 ${index + 1} (ID: ${singleId}): 写入成功。发票号码: ${invoiceData["发票号码"] || '无'} 开票日期: ${invoiceData["开票日期"] || '无'}\n`;
                         totalProcessedCount++;
                      } else {
                         outputSummary += `文件 ${index + 1} (ID: ${singleId}): 无有效数据写入，已跳过。\n`;
                      }
                  } catch (e) {
                      console.error(`处理文件 ${index + 1} (ID: ${singleId}) 数据失败:`, e);
                      outputSummary += `文件 ${index + 1} (ID: ${singleId}) 处理失败: ${e.message}\n`;
                  }

              }, function(jqXHR, textStatus, errorThrown) {
                  // 请求失败：处理单个文件请求错误
                  console.error(`DEBUG_API_ERROR_${index+1}: API 调用失败 (ID: ${singleId})。`, {textStatus, errorThrown});
                  outputSummary += `文件 ${index + 1} (ID: ${singleId}): 请求失败。状态: ${textStatus} (HTTP ${jqXHR.status})\n`;
              });
          });

          // 4. 使用 jQuery.when 等待所有请求完成，然后更新 UI
          jQuery.when.apply(jQuery, ajaxRequests).always(function() {
              resultEl.textContent = `【AI 解析结果】所有 ${idArray.length} 个请求处理完毕。成功写入 ${totalProcessedCount} 行。\n${outputSummary}`;
              rawEl.textContent = allRawResponseText;
          });
      }

      autoUpload();
  });
</script>

</html>

