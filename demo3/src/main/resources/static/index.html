<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Dify 多文件解析演示</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f4f4f4; }
        button { padding: 8px 16px; font-size: 16px; margin-bottom: 20px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #eee; }
        .section { margin-bottom: 30px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { padding: 5px; font-size: 14px; }
        .field { margin: 5px 0; }
        /* 增加文本内容列的宽度，并限制高度以便滚动 */
        .text-content-cell {
            max-width: 300px;
            max-height: 100px;
            overflow: auto;
            white-space: pre-wrap; /* 保留空白符和换行符，并自动换行 */
        }
    </style>
</head>
<body>

<h1>Dify 多文件解析</h1>

<label>输入 OA 附件 fieldId（逗号分隔）:</label> <input type="text" id="fileIds" value="44551" style="width: 300px;"> <button onclick="autoUploadMultiple()">开始自动解析</button>

<div class="section">
    <h2>解析字段 (仅显示第一个文件的结果)</h2>
    <div class="field">发票号码: <span id="invoiceNo"></span></div>
    <div class="field">开票日期: <span id="invoiceDate"></span></div>
    <div class="field">金额: <span id="amount"></span></div>
    <div class="field">税额: <span id="tax"></span></div>
    <div class="field">购买方名称: <span id="buyer"></span></div>
    <div class="field">销售方名称: <span id="seller"></span></div>
</div>

<div class="section">
    <h2>解析结果表格</h2>
    <table id="resultTable">
        <thead>
        <tr>
            <th>文件ID</th>
            <th>发票号码</th>
            <th>开票日期</th>
            <th>金额</th>
            <th>税额</th>
            <th>购买方名称</th>
            <th>销售方名称</th>
            <th>文本内容</th> </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="section">
    <h2>原始响应 (Raw Response)</h2>
    <pre id="rawResponse"></pre>
</div>

<script>
    function fillFieldsFromJson(json) {
        document.getElementById('invoiceNo').textContent = json["发票号码"] || '';
        document.getElementById('invoiceDate').textContent = json["开票日期"] || '';
        document.getElementById('amount').textContent = json["金额"] || '';
        document.getElementById('tax').textContent = json["税额"] || '';
        document.getElementById('buyer').textContent = json["购买方名称"] || '';
        document.getElementById('seller').textContent = json["销售方名称"] || '';
    }

    /**
     * 辅助函数：从 Dify 的 answer 字符串中分离出 JSON 和文本部分
     * @param {string} answer - 包含 JSON 和其他文本的字符串
     * @returns {{json: object, text: string}}
     */
    function extractJsonAndTextFromAnswer(answer) {
        let json = {};
        let text = answer;

        if (!answer) return { json, text: '' };

        // 尝试找到 JSON 块的起始 '{' 和结束 '}'
        const start = answer.indexOf('{');
        const end = answer.lastIndexOf('}');

        if (start !== -1 && end !== -1 && end > start) {
            const jsonStr = answer.substring(start, end + 1);
            try {
                // 尝试解析 JSON 字符串
                json = JSON.parse(jsonStr);

                // 提取剩余的文本内容
                const preText = answer.substring(0, start).trim();
                const postText = answer.substring(end + 1).trim();

                // 将 JSON 前后的文本拼接起来作为文本内容
                text = `${preText}\n${postText}`.trim();

            } catch (e) {
                // 解析失败，将整个 answer 视为文本
                json = {};
                text = answer;
            }
        }

        return { json, text };
    }


    async function autoUploadMultiple() {
        const btn = document.querySelector("button");
        btn.disabled = true;
        btn.textContent = "处理中...";

        const tableBody = document.querySelector("#resultTable tbody");
        const rawEl = document.getElementById("rawResponse");
        tableBody.innerHTML = "";
        rawEl.textContent = "";

        // 清空字段
        fillFieldsFromJson({});

        try {
            const ids = document.getElementById("fileIds").value
                .trim()
                .split(",")
                .map(id => id.trim()).filter(id => id); // 过滤掉空的 ID

            if (ids.length === 0) {
                alert("请输入有效的 OA 附件 fieldId。");
                return;
            }

            const query = ids.map(id => `fieldId=${id}`).join("&");
            const resp = await fetch(`http://42.193.124.96:8080/api/auto-upload?${query}`);
            const apiData = await resp.json();

            if (apiData.error) {
                alert("错误: " + apiData.error);
                return;
            }

            // Dify 返回的数据结构可能因您的中间件而异，这里假设是数组或单对象
            const filesData = Array.isArray(apiData) ? apiData : [apiData];

            filesData.forEach((fileData, index) => {
                const row = document.createElement("tr");

                // 1. 尝试将整个 raw_response 解析为 JSON，这是 Dify API 返回的完整结构
                let rawJson = {};
                try {
                    rawJson = fileData.raw_response ? JSON.parse(fileData.raw_response) : {};
                } catch(e) {
                    // 如果不是 JSON，无法处理，仅显示原始响应
                    rawEl.textContent += `文件ID ${fileData.fileId} 原始响应 (非JSON):\n` + fileData.raw_response + "\n\n";
                    return; // 跳过此文件
                }

                // 2. 从 rawJson.answer 中分离出解析结果 (json) 和文本内容 (text)
                const answerContent = rawJson.answer || "";
                const { json, text: textContent } = extractJsonAndTextFromAnswer(answerContent);

                // 3. 将完整的 raw_response 添加到原始响应区域
                rawEl.textContent += `文件ID ${fileData.fileId || "undefined"} 原始响应:\n` + fileData.raw_response + "\n\n";

                // 第一个文件自动填充字段展示部分
                if (index === 0) fillFieldsFromJson(json);

                row.innerHTML = `
                <td>${fileData.fileId || rawJson.task_id || ""}</td>
                <td>${json["发票号码"] || ""}</td>
                <td>${json["开票日期"] || ""}</td>
                <td>${json["金额"] || ""}</td>
                <td>${json["税额"] || ""}</td>
                <td>${json["购买方名称"] || ""}</td>
                <td>${json["销售方名称"] || ""}</td>
                <td class="text-content-cell">${textContent.replace(/\\n/g, '<br>')}</td> `;
                tableBody.appendChild(row);

            });

        } catch (err) {
            alert("操作失败: " + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = "开始自动解析";
        }
    }
</script>

</body>
</html>